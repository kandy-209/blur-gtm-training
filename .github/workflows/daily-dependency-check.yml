name: Daily Dependency Check

on:
  schedule:
    # Run daily at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-dependencies:
    name: Check for Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for outdated packages
        id: outdated
        run: |
          echo "ğŸ“¦ Checking outdated packages..."
          OUTDATED=$(npm outdated --json || echo "{}")
          
          # Use delimiter format for multi-line JSON output
          {
            echo "outdated<<EOF"
            echo "$OUTDATED"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          if [ "$OUTDATED" != "{}" ] && [ -n "$OUTDATED" ]; then
            echo "âš ï¸ Found outdated packages"
            # Safely pipe JSON to jq with error handling
            printf '%s\n' "$OUTDATED" | jq -r 'to_entries[] | "  â€¢ \(.key): \(.value.current) â†’ \(.value.latest)"' || true
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… All packages are up to date!"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for security vulnerabilities
        id: audit
        run: |
          echo "ğŸ”’ Checking for security vulnerabilities..."
          AUDIT=$(npm audit --json || echo "{}")
          
          # Use delimiter format for multi-line JSON output
          {
            echo "audit<<EOF"
            echo "$AUDIT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          VULN_COUNT=$(echo "$AUDIT" | jq '.vulnerabilities | length' || echo "0")
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            CRITICAL=$(echo "$AUDIT" | jq '[.vulnerabilities[] | select(.severity == "critical")] | length' || echo "0")
            HIGH=$(echo "$AUDIT" | jq '[.vulnerabilities[] | select(.severity == "high")] | length' || echo "0")
            MODERATE=$(echo "$AUDIT" | jq '[.vulnerabilities[] | select(.severity == "moderate")] | length' || echo "0")
            LOW=$(echo "$AUDIT" | jq '[.vulnerabilities[] | select(.severity == "low")] | length' || echo "0")
            
            echo "âš ï¸ Found $VULN_COUNT vulnerabilities:"
            echo "  Critical: $CRITICAL"
            echo "  High: $HIGH"
            echo "  Moderate: $MODERATE"
            echo "  Low: $LOW"
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No security vulnerabilities found!"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create summary report
        run: |
          echo "# ğŸ“Š Daily Dependency Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if updates exist before processing JSON
          if [ "${{ steps.outdated.outputs.has_updates }}" == "true" ]; then
            echo "âš ï¸ **Outdated Packages Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Safely quote and process the JSON output
            # Store context variable in a way that handles special characters
            OUTDATED_JSON="${{ steps.outdated.outputs.outdated }}"
            
            # Check if JSON is not empty, not null, and has entries (not just {})
            if [ -n "$OUTDATED_JSON" ] && [ "$OUTDATED_JSON" != "{}" ] && [ "$OUTDATED_JSON" != "null" ]; then
              # Use printf to safely handle the JSON, then pipe to jq with error handling
              # Redirect stderr to /dev/null and use || true to prevent script failure
              printf '%s\n' "$OUTDATED_JSON" | jq -r 'to_entries[] | "- **\(.key)**: \(.value.current) â†’ \(.value.latest)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  (Unable to parse package details)" >> $GITHUB_STEP_SUMMARY
            else
              echo "  (No outdated packages to display)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **All packages are up to date**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.audit.outputs.has_vulnerabilities }}" == "true" ]; then
            echo "ğŸ”’ **Security Vulnerabilities Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm audit fix\` to automatically fix vulnerabilities." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No security vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const outdated = '${{ steps.outdated.outputs.has_updates }}' === 'true';
            const vulnerabilities = '${{ steps.audit.outputs.has_vulnerabilities }}' === 'true';
            
            if (outdated || vulnerabilities) {
              const body = `## ğŸ” Dependency Check Results
              
              ${outdated ? 'âš ï¸ **Outdated packages found** - Consider updating dependencies' : 'âœ… All packages up to date'}
              ${vulnerabilities ? 'ğŸ”’ **Security vulnerabilities found** - Run `npm audit fix`' : 'âœ… No security vulnerabilities'}
              
              Check the workflow logs for details.`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

