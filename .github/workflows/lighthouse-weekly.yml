name: Lighthouse Weekly Performance Test

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

# Permissions for the workflow
permissions:
  contents: read
  actions: read

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    name: Lighthouse Performance Test
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Lighthouse CLI
        run: npm install -g lighthouse

      - name: Run Lighthouse (Mobile)
        id: lighthouse-mobile
        continue-on-error: true
        run: |
          mkdir -p lighthouse-reports
          lighthouse https://cursorsalestrainer.com \
            --only-categories=performance,accessibility,best-practices,seo \
            --preset=mobile \
            --output=html,json \
            --output-path=./lighthouse-reports/mobile \
            --chrome-flags="--headless --no-sandbox --disable-gpu" \
            --quiet

      - name: Run Lighthouse (Desktop)
        id: lighthouse-desktop
        continue-on-error: true
        run: |
          lighthouse https://cursorsalestrainer.com \
            --only-categories=performance,accessibility,best-practices,seo \
            --preset=desktop \
            --output=html,json \
            --output-path=./lighthouse-reports/desktop \
            --chrome-flags="--headless --no-sandbox --disable-gpu" \
            --quiet

      - name: Extract Scores
        id: extract-scores
        continue-on-error: true
        run: |
          # Initialize default values
          MOBILE_PERF=""
          MOBILE_A11Y=""
          MOBILE_BP=""
          MOBILE_SEO=""
          DESKTOP_PERF=""
          DESKTOP_A11Y=""
          DESKTOP_BP=""
          DESKTOP_SEO=""
          
          # Helper function to safely extract score from JSON
          extract_score() {
            local file_path=$1
            local category=$2
            local result=""
            
            if [ ! -f "$file_path" ]; then
              echo "‚ö†Ô∏è  File not found: $file_path" >&2
              echo ""
              return
            fi
            
            # Check if file is readable and not empty
            if [ ! -s "$file_path" ]; then
              echo "‚ö†Ô∏è  File is empty: $file_path" >&2
              echo ""
              return
            fi
            
            # Extract score with error handling
            # Use single quotes to prevent shell variable expansion issues
            result=$(node -e '
              try {
                const fs = require("fs");
                const filePath = process.argv[1];
                const category = process.argv[2];
                const data = fs.readFileSync(filePath, "utf8");
                const report = JSON.parse(data);
                
                if (!report || !report.categories) {
                  console.error("ERROR: Invalid Lighthouse report structure - missing categories");
                  process.exit(1);
                }
                
                const categoryData = report.categories[category];
                if (!categoryData || typeof categoryData.score !== "number") {
                  console.error(`ERROR: Category "${category}" not found or invalid score`);
                  process.exit(1);
                }
                
                console.log(Math.round(categoryData.score * 100));
              } catch (error) {
                console.error("ERROR: Failed to parse Lighthouse JSON:", error.message);
                process.exit(1);
              }
            ' "$file_path" "$category" 2>&1)
            
            local exit_code=$?
            if [ $exit_code -ne 0 ]; then
              echo "‚ùå Error extracting $category from $file_path: $result" >&2
              echo ""
              return
            fi
            
            echo "$result"
          }
          
          # Extract mobile scores
          if [ -f "./lighthouse-reports/mobile.report.json" ]; then
            echo "üì± Extracting mobile scores..."
            MOBILE_PERF=$(extract_score "./lighthouse-reports/mobile.report.json" "performance")
            MOBILE_A11Y=$(extract_score "./lighthouse-reports/mobile.report.json" "accessibility")
            MOBILE_BP=$(extract_score "./lighthouse-reports/mobile.report.json" "best-practices")
            MOBILE_SEO=$(extract_score "./lighthouse-reports/mobile.report.json" "seo")
            
            echo "mobile_perf=$MOBILE_PERF" >> $GITHUB_OUTPUT
            echo "mobile_a11y=$MOBILE_A11Y" >> $GITHUB_OUTPUT
            echo "mobile_bp=$MOBILE_BP" >> $GITHUB_OUTPUT
            echo "mobile_seo=$MOBILE_SEO" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Mobile report file not found: ./lighthouse-reports/mobile.report.json"
            echo "mobile_perf=" >> $GITHUB_OUTPUT
            echo "mobile_a11y=" >> $GITHUB_OUTPUT
            echo "mobile_bp=" >> $GITHUB_OUTPUT
            echo "mobile_seo=" >> $GITHUB_OUTPUT
          fi
          
          # Extract desktop scores
          if [ -f "./lighthouse-reports/desktop.report.json" ]; then
            echo "üñ•Ô∏è  Extracting desktop scores..."
            DESKTOP_PERF=$(extract_score "./lighthouse-reports/desktop.report.json" "performance")
            DESKTOP_A11Y=$(extract_score "./lighthouse-reports/desktop.report.json" "accessibility")
            DESKTOP_BP=$(extract_score "./lighthouse-reports/desktop.report.json" "best-practices")
            DESKTOP_SEO=$(extract_score "./lighthouse-reports/desktop.report.json" "seo")
            
            echo "desktop_perf=$DESKTOP_PERF" >> $GITHUB_OUTPUT
            echo "desktop_a11y=$DESKTOP_A11Y" >> $GITHUB_OUTPUT
            echo "desktop_bp=$DESKTOP_BP" >> $GITHUB_OUTPUT
            echo "desktop_seo=$DESKTOP_SEO" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Desktop report file not found: ./lighthouse-reports/desktop.report.json"
            echo "desktop_perf=" >> $GITHUB_OUTPUT
            echo "desktop_a11y=" >> $GITHUB_OUTPUT
            echo "desktop_bp=" >> $GITHUB_OUTPUT
            echo "desktop_seo=" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ Score extraction completed"

      - name: Display Scores
        run: |
          echo "üìä Lighthouse Scores Summary"
          echo "============================"
          echo ""
          echo "üì± Mobile:"
          echo "   Performance: ${{ steps.extract-scores.outputs.mobile_perf }}/100"
          echo "   Accessibility: ${{ steps.extract-scores.outputs.mobile_a11y }}/100"
          echo "   Best Practices: ${{ steps.extract-scores.outputs.mobile_bp }}/100"
          echo "   SEO: ${{ steps.extract-scores.outputs.mobile_seo }}/100"
          echo ""
          echo "üñ•Ô∏è  Desktop:"
          echo "   Performance: ${{ steps.extract-scores.outputs.desktop_perf }}/100"
          echo "   Accessibility: ${{ steps.extract-scores.outputs.desktop_a11y }}/100"
          echo "   Best Practices: ${{ steps.extract-scores.outputs.desktop_bp }}/100"
          echo "   SEO: ${{ steps.extract-scores.outputs.desktop_seo }}/100"

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ github.run_number }}
          path: lighthouse-reports/
          retention-days: 90

      - name: Check Performance Thresholds
        continue-on-error: true
        run: |
          # Get scores with defaults, handling empty strings
          MOBILE_PERF="${{ steps.extract-scores.outputs.mobile_perf }}"
          DESKTOP_PERF="${{ steps.extract-scores.outputs.desktop_perf }}"
          
          # Set defaults if empty
          MOBILE_PERF=${MOBILE_PERF:-0}
          DESKTOP_PERF=${DESKTOP_PERF:-0}
          
          # Check if scores are available (original output exists)
          MOBILE_AVAILABLE=false
          DESKTOP_AVAILABLE=false
          
          # Check if original output was provided (not empty)
          if [ -n "${{ steps.extract-scores.outputs.mobile_perf }}" ]; then
            MOBILE_AVAILABLE=true
          else
            echo "‚ö†Ô∏è  Mobile performance score not available"
          fi
          
          if [ -n "${{ steps.extract-scores.outputs.desktop_perf }}" ]; then
            DESKTOP_AVAILABLE=true
          else
            echo "‚ö†Ô∏è  Desktop performance score not available"
          fi
          
          # Only check thresholds if we have valid scores
          THRESHOLD_FAILED=false
          
          if [ "$MOBILE_AVAILABLE" = true ] && [ "$MOBILE_PERF" -lt 90 ]; then
            echo "‚ö†Ô∏è  Mobile performance score below threshold (90): $MOBILE_PERF/100"
            THRESHOLD_FAILED=true
          fi
          
          if [ "$DESKTOP_AVAILABLE" = true ] && [ "$DESKTOP_PERF" -lt 90 ]; then
            echo "‚ö†Ô∏è  Desktop performance score below threshold (90): $DESKTOP_PERF/100"
            THRESHOLD_FAILED=true
          fi
          
          if [ "$THRESHOLD_FAILED" = true ]; then
            echo "::warning::Performance scores below threshold. Review Lighthouse reports for optimization opportunities."
            exit 1
          elif [ "$MOBILE_AVAILABLE" = true ] || [ "$DESKTOP_AVAILABLE" = true ]; then
            echo "‚úÖ Performance scores meet threshold (‚â•90)"
          else
            echo "‚ö†Ô∏è  No performance scores available to check"
          fi

