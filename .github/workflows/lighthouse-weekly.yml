name: Lighthouse Weekly Performance Test

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

# Permissions for the workflow
permissions:
  contents: read
  actions: read

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    name: Lighthouse Performance Test
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Lighthouse CLI
        run: npm install -g lighthouse

      - name: Run Lighthouse (Mobile)
        id: lighthouse-mobile
        continue-on-error: true
        run: |
          mkdir -p lighthouse-reports
          lighthouse https://cursorsalestrainer.com \
            --only-categories=performance,accessibility,best-practices,seo \
            --preset=mobile \
            --output=html,json \
            --output-path=./lighthouse-reports/mobile \
            --chrome-flags="--headless --no-sandbox --disable-gpu" \
            --quiet

      - name: Run Lighthouse (Desktop)
        id: lighthouse-desktop
        continue-on-error: true
        run: |
          lighthouse https://cursorsalestrainer.com \
            --only-categories=performance,accessibility,best-practices,seo \
            --preset=desktop \
            --output=html,json \
            --output-path=./lighthouse-reports/desktop \
            --chrome-flags="--headless --no-sandbox --disable-gpu" \
            --quiet

      - name: Extract Scores
        id: extract-scores
        run: |
          # Initialize default values
          MOBILE_PERF=""
          MOBILE_A11Y=""
          MOBILE_BP=""
          MOBILE_SEO=""
          DESKTOP_PERF=""
          DESKTOP_A11Y=""
          DESKTOP_BP=""
          DESKTOP_SEO=""
          
          if [ -f "./lighthouse-reports/mobile.report.json" ]; then
            MOBILE_PERF=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/mobile.report.json'));console.log(Math.round((d.categories?.performance?.score||0)*100))")
            MOBILE_A11Y=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/mobile.report.json'));console.log(Math.round((d.categories?.accessibility?.score||0)*100))")
            MOBILE_BP=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/mobile.report.json'));console.log(Math.round((d.categories?.['best-practices']?.score||0)*100))")
            MOBILE_SEO=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/mobile.report.json'));console.log(Math.round((d.categories?.seo?.score||0)*100))")
            echo "mobile_perf=$MOBILE_PERF" >> $GITHUB_OUTPUT
            echo "mobile_a11y=$MOBILE_A11Y" >> $GITHUB_OUTPUT
            echo "mobile_bp=$MOBILE_BP" >> $GITHUB_OUTPUT
            echo "mobile_seo=$MOBILE_SEO" >> $GITHUB_OUTPUT
          else
            echo "mobile_perf=" >> $GITHUB_OUTPUT
            echo "mobile_a11y=" >> $GITHUB_OUTPUT
            echo "mobile_bp=" >> $GITHUB_OUTPUT
            echo "mobile_seo=" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "./lighthouse-reports/desktop.report.json" ]; then
            DESKTOP_PERF=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/desktop.report.json'));console.log(Math.round((d.categories?.performance?.score||0)*100))")
            DESKTOP_A11Y=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/desktop.report.json'));console.log(Math.round((d.categories?.accessibility?.score||0)*100))")
            DESKTOP_BP=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/desktop.report.json'));console.log(Math.round((d.categories?.['best-practices']?.score||0)*100))")
            DESKTOP_SEO=$(node -e "const fs=require('fs');const d=JSON.parse(fs.readFileSync('./lighthouse-reports/desktop.report.json'));console.log(Math.round((d.categories?.seo?.score||0)*100))")
            echo "desktop_perf=$DESKTOP_PERF" >> $GITHUB_OUTPUT
            echo "desktop_a11y=$DESKTOP_A11Y" >> $GITHUB_OUTPUT
            echo "desktop_bp=$DESKTOP_BP" >> $GITHUB_OUTPUT
            echo "desktop_seo=$DESKTOP_SEO" >> $GITHUB_OUTPUT
          else
            echo "desktop_perf=" >> $GITHUB_OUTPUT
            echo "desktop_a11y=" >> $GITHUB_OUTPUT
            echo "desktop_bp=" >> $GITHUB_OUTPUT
            echo "desktop_seo=" >> $GITHUB_OUTPUT
          fi

      - name: Display Scores
        run: |
          echo "üìä Lighthouse Scores Summary"
          echo "============================"
          echo ""
          echo "üì± Mobile:"
          echo "   Performance: ${{ steps.extract-scores.outputs.mobile_perf }}/100"
          echo "   Accessibility: ${{ steps.extract-scores.outputs.mobile_a11y }}/100"
          echo "   Best Practices: ${{ steps.extract-scores.outputs.mobile_bp }}/100"
          echo "   SEO: ${{ steps.extract-scores.outputs.mobile_seo }}/100"
          echo ""
          echo "üñ•Ô∏è  Desktop:"
          echo "   Performance: ${{ steps.extract-scores.outputs.desktop_perf }}/100"
          echo "   Accessibility: ${{ steps.extract-scores.outputs.desktop_a11y }}/100"
          echo "   Best Practices: ${{ steps.extract-scores.outputs.desktop_bp }}/100"
          echo "   SEO: ${{ steps.extract-scores.outputs.desktop_seo }}/100"

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ github.run_number }}
          path: lighthouse-reports/
          retention-days: 90

      - name: Check Performance Thresholds
        continue-on-error: true
        run: |
          # Get scores with defaults, handling empty strings
          MOBILE_PERF="${{ steps.extract-scores.outputs.mobile_perf }}"
          DESKTOP_PERF="${{ steps.extract-scores.outputs.desktop_perf }}"
          
          # Set defaults if empty
          MOBILE_PERF=${MOBILE_PERF:-0}
          DESKTOP_PERF=${DESKTOP_PERF:-0}
          
          # Check if scores are available (original output exists)
          MOBILE_AVAILABLE=false
          DESKTOP_AVAILABLE=false
          
          # Check if original output was provided (not empty)
          if [ -n "${{ steps.extract-scores.outputs.mobile_perf }}" ]; then
            MOBILE_AVAILABLE=true
          else
            echo "‚ö†Ô∏è  Mobile performance score not available"
          fi
          
          if [ -n "${{ steps.extract-scores.outputs.desktop_perf }}" ]; then
            DESKTOP_AVAILABLE=true
          else
            echo "‚ö†Ô∏è  Desktop performance score not available"
          fi
          
          # Only check thresholds if we have valid scores
          THRESHOLD_FAILED=false
          
          if [ "$MOBILE_AVAILABLE" = true ] && [ "$MOBILE_PERF" -lt 90 ]; then
            echo "‚ö†Ô∏è  Mobile performance score below threshold (90): $MOBILE_PERF/100"
            THRESHOLD_FAILED=true
          fi
          
          if [ "$DESKTOP_AVAILABLE" = true ] && [ "$DESKTOP_PERF" -lt 90 ]; then
            echo "‚ö†Ô∏è  Desktop performance score below threshold (90): $DESKTOP_PERF/100"
            THRESHOLD_FAILED=true
          fi
          
          if [ "$THRESHOLD_FAILED" = true ]; then
            echo "::warning::Performance scores below threshold. Review Lighthouse reports for optimization opportunities."
            exit 1
          elif [ "$MOBILE_AVAILABLE" = true ] || [ "$DESKTOP_AVAILABLE" = true ]; then
            echo "‚úÖ Performance scores meet threshold (‚â•90)"
          else
            echo "‚ö†Ô∏è  No performance scores available to check"
          fi

