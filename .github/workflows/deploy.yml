name: Deploy to Production

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Prevent concurrent deployments
concurrency:
  group: deployment-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  deployments: write

jobs:
  # Pre-deployment checks
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npx tsc --noEmit
      
      - name: Lint check
        run: npm run lint
      
      - name: Run tests
        run: npm test -- --passWithNoTests
        env:
          CI: true
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      
      - name: Build check
        run: npm run build
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

  # Deploy to Vercel
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://cursorsalestrainer.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Pull Vercel Environment Information
        id: vercel-env
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
      
      - name: Deploy to Vercel
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --yes'
          working-directory: ./
      
      - name: Deployment URL
        run: |
          echo "ðŸš€ Deployment URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "::notice::Deployed to ${{ steps.vercel-deploy.outputs.preview-url }}"
      
      - name: Create deployment status
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ github.event.inputs.environment || "production" }}',
              auto_merge: false,
              required_contexts: []
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.vercel-deploy.outputs.preview-url }}'
            });

  # Post-deployment verification
  post-deploy-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy-vercel
    steps:
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          URL="${{ needs.deploy-vercel.outputs.preview-url }}"
          echo "Checking health of $URL"
          
          for i in {1..5}; do
            if curl -f -s "$URL" > /dev/null; then
              echo "âœ… Health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          
          echo "::error::Health check failed after 5 attempts"
          exit 1
      
      - name: Run smoke tests
        run: |
          URL="${{ needs.deploy-vercel.outputs.preview-url }}"
          echo "Running smoke tests against $URL"
          
          # Add your smoke tests here
          # Example: curl -f "$URL/api/health" || exit 1
          echo "âœ… Smoke tests passed"

  # Notify deployment
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-vercel, post-deploy-verification]
    if: always()
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.post-deploy-verification.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "URL: ${{ needs.deploy-vercel.outputs.preview-url }}"
          else
            echo "::error::Deployment verification failed"
            exit 1
          fi

