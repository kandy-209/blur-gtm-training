#!/usr/bin/env node

// Interactive production setup script
const readline = require('readline');
const fs = require('fs');
const path = require('path');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

async function main() {
  console.log('üöÄ Production Setup Wizard\n');
  console.log('This will help you set up your production environment.\n');

  // Step 1: Check Supabase
  const hasSupabase = await question('Do you have a Supabase account? (y/n): ');
  if (hasSupabase.toLowerCase() !== 'y') {
    console.log('\nüìù Please create a Supabase account first:');
    console.log('   1. Go to https://supabase.com');
    console.log('   2. Sign up/login');
    console.log('   3. Create a new project');
    console.log('   4. Run the migration script (scripts/migrate-database.sql)');
    console.log('   5. Get your credentials from Settings ‚Üí API\n');
    return;
  }

  // Step 2: Get Supabase credentials
  console.log('\nüìã Supabase Credentials:');
  console.log('   Go to Supabase Dashboard ‚Üí Settings ‚Üí API');
  const supabaseUrl = await question('   Enter NEXT_PUBLIC_SUPABASE_URL: ');
  const supabaseKey = await question('   Enter SUPABASE_SERVICE_ROLE_KEY: ');

  // Step 3: Get OpenAI key
  console.log('\nüìã OpenAI API Key:');
  console.log('   Get from https://platform.openai.com/api-keys');
  const openaiKey = await question('   Enter OPENAI_API_KEY: ');

  // Step 4: Get ElevenLabs (optional)
  console.log('\nüìã ElevenLabs (Optional - press Enter to skip):');
  const elevenlabsKey = await question('   Enter ELEVENLABS_API_KEY: ');
  const elevenlabsAgentId = await question('   Enter NEXT_PUBLIC_ELEVENLABS_AGENT_ID: ');

  // Step 5: Create .env.production
  const envContent = `# Production Environment Variables
# Generated by setup-production.js

OPENAI_API_KEY=${openaiKey}
NEXT_PUBLIC_SUPABASE_URL=${supabaseUrl}
SUPABASE_SERVICE_ROLE_KEY=${supabaseKey}
${elevenlabsKey ? `ELEVENLABS_API_KEY=${elevenlabsKey}` : ''}
${elevenlabsAgentId ? `NEXT_PUBLIC_ELEVENLABS_AGENT_ID=${elevenlabsAgentId}` : ''}
ALLOWED_ORIGINS=
NODE_ENV=production
`;

  fs.writeFileSync('.env.production', envContent);
  console.log('\n‚úÖ Created .env.production file');

  // Step 6: Install Supabase
  console.log('\nüì¶ Installing Supabase client...');
  const { execSync } = require('child_process');
  try {
    execSync('npm install @supabase/supabase-js', { stdio: 'inherit' });
    console.log('‚úÖ Supabase installed');
  } catch (error) {
    console.log('‚ùå Failed to install Supabase. Run: npm install @supabase/supabase-js');
  }

  // Step 7: Create production database file
  console.log('\nüìù Creating production database file...');
  const dbProductionExample = path.join(__dirname, 'src/lib/db-production.ts.example');
  const dbProduction = path.join(__dirname, 'src/lib/db-production.ts');
  
  if (fs.existsSync(dbProductionExample)) {
    let content = fs.readFileSync(dbProductionExample, 'utf8');
    content = content.replace(
      /const supabaseUrl = process\.env\.NEXT_PUBLIC_SUPABASE_URL!/,
      `const supabaseUrl = '${supabaseUrl}'`
    );
    content = content.replace(
      /const supabaseKey = process\.env\.SUPABASE_SERVICE_ROLE_KEY!/,
      `const supabaseKey = '${supabaseKey}'`
    );
    fs.writeFileSync(dbProduction, content);
    console.log('‚úÖ Created src/lib/db-production.ts');
  }

  console.log('\n‚úÖ Setup complete!');
  console.log('\nüìã Next steps:');
  console.log('   1. Review DEPLOY_NOW.md for deployment instructions');
  console.log('   2. Test locally: npm run dev');
  console.log('   3. Deploy to Vercel (see DEPLOY_NOW.md)');
  console.log('\n‚ö†Ô∏è  Remember to:');
  console.log('   - Add environment variables to Vercel dashboard');
  console.log('   - Run database migration in Supabase');
  console.log('   - Test your deployment');

  rl.close();
}

main().catch(console.error);

